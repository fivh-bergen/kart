---
import { Map } from "../components/Map";
import { Panel } from "../components/Panel";
import Layout from "../layouts/Layout.astro";
---

<Layout>
  <Map client:only="react" />
  <Panel client:only="react" />
</Layout>

<script>
  import "maplibre-gl/dist/maplibre-gl.css";
  import { $map } from "../store/map";
  import features from "../data/features.json";
  import maplibregl from "maplibre-gl";
  import { setFeature } from "../store/feature";
  import { showInfoPanel } from "../store/feature";
  import { panMapToShowMarker } from "../utils/pan-map";

  $map.subscribe((map) => {
    if (map) {
      map.dragRotate.disable();

      features.elements.forEach((feature) => {
        // add marker to map
        const marker = new maplibregl.Marker()
          .setLngLat([feature.lon, feature.lat])
          .addTo(map);

        const element = marker.getElement();

        // add click event to open the info panel and pan camera if necessary
        element.addEventListener("click", () => {
          // Pan the camera so the marker is not behind the panel
          panMapToShowMarker(map, feature.lon, feature.lat);
          setFeature({
            name: feature.tags.name ?? "Navn mangler",
            description: feature.tags.description ?? "",
            opening_hours: feature.tags.opening_hours ?? "",
            lat: feature.lat,
            long: feature.lon,
            id: feature.id,
            website: feature.tags.website,
            facebook: feature.tags["contact:facebook"],
            address: {
              street: feature.tags["addr:street"],
              buildingNumber: feature.tags["addr:housenumber"],
              postalCode: feature.tags["addr:postcode"],
              city: feature.tags["addr:city"],
            },
          });
          showInfoPanel();
        });
        element.style.cursor = "pointer";
      });
    }
  });
</script>
