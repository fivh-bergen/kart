---
import { Map } from "../components/Map";
import { Panel } from "../components/Panel";
import Layout from "../layouts/Layout.astro";
---

<Layout>
  <Map client:only="react" />
  <Panel client:only="react" />
</Layout>

<script>
  import "maplibre-gl/dist/maplibre-gl.css";
  import { $map } from "../store/map";
  import {features} from "../overpass/features";
  import maplibregl from "maplibre-gl";
  import { setFeature } from "../store/feature";
  import { showInfoPanel } from "../store/feature";
  import { panMapToShowMarker } from "../utils/pan-map";

  $map.subscribe((map) => {
    if (map) {
      map.dragRotate.disable();

      features.features.forEach((feature) => {
        // add marker to map
        const marker = new maplibregl.Marker({color: '#FF7A00'})
          .setLngLat(feature.geometry.coordinates)
          .addTo(map);

        const element = marker.getElement();

        // add click event to open the info panel and pan camera if necessary
        element.addEventListener("click", () => {
          // Pan the camera so the marker is not behind the panel
          panMapToShowMarker(map, feature.geometry.coordinates[0], feature.geometry.coordinates[1]);
          setFeature(feature);
          showInfoPanel();
        });
        element.style.cursor = "pointer";
      });
    }
  });
</script>
